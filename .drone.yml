pipeline:
  build:
    image: elixir:1.5.1
    links:
      - db
    commands:
      - mix local.hex --force
      - mix deps.get
      - mix local.rebar --force
      - sleep 10
      - mix ecto.create
      - mix ecto.migrate
      - mix test
  deploy:
    image: quay.io/honestbee/drone-kubernetes
    kubernetes_server: ${KUBERNETES_SERVER_DRUNKSHIP}
    kubernetes_cert: ${KUBERNETES_CERT_DRUNKSHIP}
    kubernetes_token: ${KUBERNETES_TOKEN_DRUNKSHIP}
    deployment: slowmonster
    repo: gcr.io/drunkship-159205/github-composit-slowmonster
    container: slowmonster
    namespace: drunkship
    tag:
      - mytag
services:
  db:
    image: postgres:9.6.5
    environment:
      - POSTGRES_PASSWORD=b4o6L6ZSbUBP
